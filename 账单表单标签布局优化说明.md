# 账单表单标签布局优化说明

## 优化内容

### 问题描述
原来的标签布局使用 `LazyVGrid` 固定网格布局，标签间隔较大，空间利用率不高，不够紧凑。

### 解决方案
将 `LazyVGrid` 替换为自定义的 `FlowLayout` 流式布局，标签按内容宽度自然排列，放不下时自动换行。

## 具体改进

### 1. 归属人标签布局

#### 修改前
```swift
LazyVGrid(columns: [GridItem(.adaptive(minimum: 80))], spacing: 8) {
    ForEach(owners) { owner in
        SelectableTagView(...)
    }
}
```

#### 修改后
```swift
FlowLayout(spacing: 8) {
    ForEach(owners) { owner in
        SelectableTagView(...)
    }
}
```

### 2. 支付方式标签布局

#### 修改前
```swift
LazyVGrid(columns: [GridItem(.adaptive(minimum: 100))], spacing: 8) {
    ForEach(filteredPaymentMethods, id: \.id) { method in
        SelectableTagView(...)
    }
}
```

#### 修改后
```swift
FlowLayout(spacing: 8) {
    ForEach(filteredPaymentMethods, id: \.id) { method in
        SelectableTagView(...)
    }
}
```

### 3. 账单类型标签布局

#### 修改前
```swift
LazyVGrid(columns: [GridItem(.adaptive(minimum: 80))], spacing: 8) {
    ForEach(filteredCategories) { category in
        SelectableTagView(...)
    }
}
```

#### 修改后
```swift
FlowLayout(spacing: 8) {
    ForEach(filteredCategories) { category in
        SelectableTagView(...)
    }
}
```

## 自定义 FlowLayout 实现

### 核心特性
```swift
struct FlowLayout: Layout {
    let spacing: CGFloat
    
    // 计算所需尺寸
    func sizeThatFits(proposal: ProposedViewSize, subviews: Subviews, cache: inout ()) -> CGSize
    
    // 放置子视图
    func placeSubviews(in bounds: CGRect, proposal: ProposedViewSize, subviews: Subviews, cache: inout ())
}
```

### 布局算法
```swift
struct FlowResult {
    // 1. 遍历所有子视图
    // 2. 计算当前行是否能放下下一个标签
    // 3. 如果放不下，换行并重置 X 坐标
    // 4. 记录每个标签的位置和尺寸
    // 5. 计算整体布局的边界
}
```

## 布局优化效果

### 1. 空间利用率提升
- **原来**: 固定网格，可能有大量空白
- **现在**: 流式布局，标签紧密排列

### 2. 自适应宽度
- **原来**: 最小宽度限制（80px/100px）
- **现在**: 根据内容自动调整宽度

### 3. 自然换行
- **原来**: 按列数强制换行
- **现在**: 按实际宽度智能换行

### 4. 视觉效果
- **更紧凑**: 减少不必要的空白
- **更自然**: 标签排列更符合阅读习惯
- **更高效**: 屏幕空间利用率更高

## 技术实现细节

### Layout 协议
- **iOS 16+**: 使用新的 Layout 协议
- **性能优化**: 高效的布局计算
- **响应式**: 自动适应容器宽度变化

### 布局计算逻辑
1. **测量阶段**: 计算每个标签的理想尺寸
2. **排列阶段**: 按行排列，超出宽度时换行
3. **定位阶段**: 确定每个标签的最终位置
4. **边界计算**: 计算整体布局的尺寸

### 兼容性考虑
- **iOS 16+**: 原生 Layout 协议支持
- **iOS 15**: 可能需要降级处理（如果需要）

## 用户体验提升

### 1. 视觉密度
- 标签排列更紧凑，一屏显示更多内容
- 减少滚动操作，提高选择效率

### 2. 操作便利性
- 标签位置更自然，符合用户期望
- 减少空白点击区域，提高点击准确性

### 3. 适配性
- 自动适应不同屏幕尺寸
- 横竖屏切换时自动重新布局

## 测试建议

1. **不同屏幕尺寸**: 测试 iPhone SE、iPhone 15、iPad 等
2. **不同标签数量**: 测试少量和大量标签的布局效果
3. **不同标签长度**: 测试短标签和长标签的混合布局
4. **横竖屏切换**: 测试布局的自适应能力
5. **动态内容**: 测试标签增减时的布局变化

这次优化显著提升了标签布局的空间利用率和视觉效果，让界面更加紧凑和美观。