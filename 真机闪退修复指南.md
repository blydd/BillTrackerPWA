# 真机闪退修复指南

## ✅ 已执行的修复

已临时禁用云同步功能，这样可以先测试 IAP 功能。

## 🔄 重新安装步骤

1. **清理构建**：按 **Shift + ⌘ + K**
2. **重新编译**：按 **⌘ + B**
3. **运行到真机**：按 **⌘ + R**
4. 应用应该能正常启动了

---

## 🎯 如果还是闪退

### 查看崩溃原因

#### 方法 1：Xcode Console
1. 在 Xcode 中运行应用
2. 查看底部 Console 的输出
3. 找到类似这样的错误信息：
   ```
   *** Terminating app due to uncaught exception...
   ```
4. 截图或复制给我

#### 方法 2：设备日志
1. **Window** → **Devices and Simulators**
2. 选择你的设备
3. 点击 **View Device Logs**
4. 找到最新的崩溃日志

---

## 🐛 常见闪退原因及解决方案

### 1. CloudKit 权限问题
**症状**：真机启动立即崩溃
**原因**：CloudKit 需要正确的 entitlements 配置
**解决**：已禁用云同步（临时）

### 2. 数据库初始化失败
**症状**：启动时崩溃，Console 显示 SQLite 错误
**原因**：数据库文件权限或路径问题
**解决**：
```swift
// 在 ExpenseTrackerApp.swift 中已有回退逻辑
catch {
    print("❌ SQLite 初始化失败: \(error)")
    return UserDefaultsRepository()
}
```

### 3. StoreKit 配置问题
**症状**：点击升级按钮时崩溃
**原因**：StoreKit Configuration 未配置
**解决**：
1. Edit Scheme → Run → Options
2. StoreKit Configuration: Products.storekit

### 4. 代码签名问题
**症状**：安装后无法启动
**原因**：Bundle Identifier 或签名配置错误
**解决**：
1. 检查 Bundle Identifier 是否唯一
2. 检查 Team 是否正确选择
3. 检查 Provisioning Profile

---

## 🧪 测试步骤（应用启动后）

### 1. 基础功能测试
- [ ] 应用能正常启动
- [ ] 能看到账单列表
- [ ] 能进入设置页面

### 2. IAP 功能测试
- [ ] 设置页面显示订阅状态（应该显示"免费版"）
- [ ] 点击"升级"按钮能打开购买界面
- [ ] 购买界面显示两个产品选项
- [ ] 功能对比表格正确显示

### 3. 限制功能测试
- [ ] 创建账单到 450 条时显示警告
- [ ] 创建账单到 500 条时被阻止
- [ ] 点击导出按钮提示升级
- [ ] 点击云同步提示升级（如果启用了云同步）

---

## 🔧 如果需要启用云同步

等 IAP 功能测试完成后，可以重新启用云同步：

1. 打开 `ExpenseTracker/ExpenseTrackerApp.swift`
2. 找到 `var body: some Scene`
3. 取消注释原来的代码：
```swift
#if targetEnvironment(simulator)
ContentView(repository: repository)
#else
ContentViewWithSync(repository: repository)
#endif
```
4. 注释掉临时的代码

但需要先配置 CloudKit：
- 在 Signing & Capabilities 中添加 iCloud capability
- 选择 CloudKit
- 配置 Container

---

## 📊 崩溃日志示例

如果看到类似这样的错误，请告诉我：

```
Fatal error: Unexpectedly found nil while unwrapping an Optional value
```

或

```
Thread 1: signal SIGABRT
```

或

```
*** Terminating app due to uncaught exception 'NSInvalidArgumentException'
```

---

## 💡 调试技巧

### 添加断点
1. 在 `ExpenseTrackerApp.swift` 的 `init()` 方法中添加断点
2. 运行应用
3. 查看是否能执行到断点
4. 如果不能，说明在初始化前就崩溃了

### 查看 Console 输出
应用启动时应该看到：
```
✅ SQLite 数据库初始化成功
✅ 数据表创建成功
```

如果看到错误信息，请告诉我。

---

## 🆘 需要帮助

如果还是闪退，请提供：
1. Xcode Console 的完整输出（截图）
2. 崩溃日志（如果有）
3. 具体的错误信息

我会帮你进一步诊断！
