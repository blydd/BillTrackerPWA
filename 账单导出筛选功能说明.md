# 账单导出筛选功能说明

## 功能概述
优化账单导出功能，支持按照当前筛选条件导出账单，并在导出前显示确认对话框。

## 优化前

### 原有行为
- 导出按钮始终导出全部账单
- 即使设置了筛选条件，也会导出所有账单
- 没有导出确认提示
- 用户不知道将要导出多少条账单

### 问题
1. ❌ 筛选功能与导出功能脱节
2. ❌ 无法导出特定条件的账单
3. ❌ 可能误导出大量不需要的数据
4. ❌ 没有导出前的确认步骤

## 优化后

### 新功能特性

#### 1. 按筛选条件导出
- ✅ 有筛选条件时，只导出符合条件的账单
- ✅ 无筛选条件时，导出全部账单
- ✅ 自动识别当前筛选状态

#### 2. 导出按钮显示优化
**无筛选条件**:
```
┌─────────────┐
│ 📤 导出     │
└─────────────┘
```

**有筛选条件**:
```
┌─────────────┐
│ 📤 导出     │
│    125条    │
└─────────────┘
```
- 显示将要导出的账单数量
- 蓝色文字提示有筛选

#### 3. 导出确认对话框
**无筛选条件**:
```
┌──────────────────────────┐
│ 确认导出                  │
├──────────────────────────┤
│ 将导出全部 500 条账单     │
│                          │
│ [取消]         [导出]    │
└──────────────────────────┘
```

**有筛选条件**:
```
┌──────────────────────────┐
│ 确认导出                  │
├──────────────────────────┤
│ 将导出符合以下条件的      │
│ 125 条账单：              │
│                          │
│ 归属人: 张三、李四        │
│ 类型: 餐饮、交通          │
│ 支付方式: 3个             │
│ 日期: 12-01~12-09        │
│                          │
│ [取消]         [导出]    │
└──────────────────────────┘
```

## 技术实现

### 1. 导出逻辑修改

#### 原代码
```swift
private func exportBills() {
    // 始终导出全部账单
    let fileURL = try await exportViewModel.exportToCSV(
        bills: billViewModel.bills,
        // ...
    )
}
```

#### 新代码
```swift
private func exportBills() {
    // 检查权限
    if !subscriptionManager.canExportData {
        showingUpgradePrompt = true
        return
    }
    
    // 显示确认对话框
    showingExportConfirmation = true
}

private func performExport() {
    // 根据筛选状态选择要导出的账单
    let billsToExport = hasActiveFilters ? filteredBills : billViewModel.bills
    
    let fileURL = try await exportViewModel.exportToCSV(
        bills: billsToExport,
        // ...
    )
}
```

### 2. 导出按钮优化

#### 显示筛选数量
```swift
Button {
    exportBills()
} label: {
    HStack(spacing: 6) {
        if exportViewModel.isExporting {
            ProgressView()
        } else {
            Image(systemName: "square.and.arrow.up")
                .font(.title3)
            VStack(alignment: .leading, spacing: 0) {
                Text("导出")
                    .font(.headline)
                if hasActiveFilters {
                    Text("\(filteredBills.count)条")
                        .font(.system(size: 9))
                        .foregroundColor(.blue)
                }
            }
        }
    }
}
```

### 3. 确认对话框实现

#### 状态变量
```swift
@State private var showingExportConfirmation = false
```

#### 对话框
```swift
.alert("确认导出", isPresented: $showingExportConfirmation) {
    Button("取消", role: .cancel) {}
    Button("导出") {
        performExport()
    }
} message: {
    Text(exportConfirmationMessage)
}
```

#### 确认消息生成
```swift
private var exportConfirmationMessage: String {
    let billsToExport = hasActiveFilters ? filteredBills : billViewModel.bills
    let count = billsToExport.count
    
    if hasActiveFilters {
        var conditions: [String] = []
        
        // 归属人
        if !selectedOwnerIds.isEmpty {
            let names = selectedOwnerIds.compactMap { id in
                ownerViewModel.owners.first(where: { $0.id == id })?.name
            }.joined(separator: "、")
            conditions.append("归属人: \(names)")
        }
        
        // 账单类型
        if !selectedCategoryIds.isEmpty {
            let names = selectedCategoryIds.compactMap { id in
                categoryViewModel.categories.first(where: { $0.id == id })?.name
            }.joined(separator: "、")
            conditions.append("类型: \(names)")
        }
        
        // 支付方式
        if !selectedPaymentMethodIds.isEmpty {
            conditions.append("支付方式: \(selectedPaymentMethodIds.count)个")
        }
        
        // 日期范围
        if let start = startDate, let end = endDate {
            conditions.append("日期: \(format(start))~\(format(end))")
        } else if let start = startDate {
            conditions.append("日期: \(format(start))起")
        } else if let end = endDate {
            conditions.append("日期: 至\(format(end))")
        }
        
        let conditionText = conditions.joined(separator: "\n")
        return "将导出符合以下条件的 \(count) 条账单：\n\n\(conditionText)"
    } else {
        return "将导出全部 \(count) 条账单"
    }
}
```

### 4. 日志输出

添加详细的导出日志：
```swift
print("📤 导出账单: 总数=\(billViewModel.bills.count), 筛选后=\(billsToExport.count)")
if hasActiveFilters {
    print("  筛选条件:")
    if !selectedOwnerIds.isEmpty {
        print("  - 归属人: \(selectedOwnerIds.count) 个")
    }
    if !selectedCategoryIds.isEmpty {
        print("  - 账单类型: \(selectedCategoryIds.count) 个")
    }
    if !selectedPaymentMethodIds.isEmpty {
        print("  - 支付方式: \(selectedPaymentMethodIds.count) 个")
    }
    if startDate != nil || endDate != nil {
        print("  - 日期范围: 有")
    }
}
```

## 使用场景

### 场景 1: 导出全部账单
1. 不设置任何筛选条件
2. 点击"导出"按钮
3. 确认对话框显示: "将导出全部 500 条账单"
4. 点击"导出"
5. 生成包含所有账单的 CSV 文件

### 场景 2: 导出特定归属人的账单
1. 在筛选中选择"张三"
2. 列表显示张三的 125 条账单
3. 导出按钮显示"导出 125条"
4. 点击导出
5. 确认对话框显示: "将导出符合以下条件的 125 条账单：归属人: 张三"
6. 点击"导出"
7. 生成只包含张三账单的 CSV 文件

### 场景 3: 导出特定时间段的账单
1. 设置日期范围: 2024-12-01 ~ 2024-12-09
2. 列表显示该时间段的 80 条账单
3. 导出按钮显示"导出 80条"
4. 点击导出
5. 确认对话框显示筛选条件和数量
6. 点击"导出"
7. 生成该时间段的 CSV 文件

### 场景 4: 组合筛选导出
1. 选择归属人: 张三、李四
2. 选择类型: 餐饮、交通
3. 选择支付方式: 3个
4. 设置日期范围: 12-01 ~ 12-09
5. 列表显示符合所有条件的 45 条账单
6. 导出按钮显示"导出 45条"
7. 点击导出
8. 确认对话框显示所有筛选条件
9. 点击"导出"
10. 生成精确筛选后的 CSV 文件

## 用户体验提升

### 1. 明确性
- ✅ 用户清楚知道将要导出多少条账单
- ✅ 用户清楚知道导出的筛选条件
- ✅ 避免误导出不需要的数据

### 2. 灵活性
- ✅ 可以导出全部账单
- ✅ 可以导出特定条件的账单
- ✅ 支持复杂的组合筛选

### 3. 安全性
- ✅ 导出前有确认步骤
- ✅ 可以取消导出操作
- ✅ 避免误操作

### 4. 反馈性
- ✅ 导出按钮显示数量
- ✅ 确认对话框显示详细信息
- ✅ 控制台输出详细日志

## 实际应用示例

### 财务报表场景
**需求**: 导出 2024 年 12 月的所有餐饮支出

**操作**:
1. 筛选类型: 餐饮
2. 筛选日期: 2024-12-01 ~ 2024-12-31
3. 点击导出
4. 确认对话框显示: "将导出符合以下条件的 XX 条账单：类型: 餐饮，日期: 12-01~12-31"
5. 导出 CSV
6. 在 Excel 中进一步分析

### 个人账单场景
**需求**: 导出张三的所有账单用于个人报销

**操作**:
1. 筛选归属人: 张三
2. 点击导出
3. 确认对话框显示: "将导出符合以下条件的 XX 条账单：归属人: 张三"
4. 导出 CSV
5. 提交给财务部门

### 季度总结场景
**需求**: 导出 Q4 的所有账单

**操作**:
1. 筛选日期: 2024-10-01 ~ 2024-12-31
2. 点击导出
3. 确认对话框显示日期范围和数量
4. 导出 CSV
5. 用于季度财务分析

## 注意事项

### 1. 筛选缓存
- 导出使用 `filteredBills` 计算属性
- 该属性已经实现了缓存机制
- 确保导出的数据与列表显示一致

### 2. 性能考虑
- 大量账单导出时可能需要时间
- 已有 `isExporting` 状态显示进度
- 导出期间禁用导出按钮

### 3. 权限检查
- 导出前检查 Pro 权限
- 免费用户显示升级提示
- Pro 用户正常导出

### 4. 错误处理
- 导出失败显示错误提示
- 控制台输出详细错误信息
- 用户可以重试

## 相关文件
- `Views/BillListView.swift` - 账单列表视图
- `ViewModels/ExportViewModel.swift` - 导出逻辑

## 优化日期
2025-12-09

## 未来改进建议

### 1. 导出格式选择
- 支持 CSV、Excel、PDF 等多种格式
- 用户可以选择导出格式

### 2. 导出模板
- 保存常用的筛选条件为模板
- 快速导出特定类型的账单

### 3. 自动导出
- 定期自动导出账单
- 发送到邮箱或云存储

### 4. 导出历史
- 记录导出历史
- 可以重新下载之前的导出文件
